function getText(e){return e?"string"==typeof e?e.replace(/\n/gm,"").trim():e.content?e.content.replace(/[\s]{3,}/gm,"\n").trim():e[0].content.replace(/[\s]{3,}/gm,"\n").trim():""}var Moment=require("vendor/moment");Moment.locale("de"),module.exports=function(e){if(Ti.App.Properties.hasProperty(e.date))return void e.onload(JSON.parse(Ti.App.Properties.getString(e.date)));var t='select * from html where url="http://s507870211.online.de/index.php?aktion=suche&dat='+e.date+'" and xpath="//table"';return void Ti.Yahoo.yql(t,function(t){if(t.success&&t.data&&t.data.table&&Array.isArray(t.data.table)){var r=t.data.table,i=[];r.forEach(function(t){if("form"!=t["class"]){var r={};t.tbody.tr&&t.tbody.tr instanceof Array&&t.tbody.tr.forEach(function(t){if(t.th&&(r.title=t.th.h1,r.subtitle=t.th.h2),t.td&&"navi"!=t.td["class"])for(var i=0;i<t.td.length;i++)if("right"==t.td[i]["class"])switch(t.td[i].content){case"Sendetermine:":r.meta=getText(t.td[i+1].content).replace("angekündigte Länge:    ","ca. Länge:"),r.station=r.meta.split(" - ")[0];var n=r.meta.match(/\s(\d\d:\d\d)/);r.time=n[1];var o=e.date+" "+r.time,a=Moment(o,"YYYY-MM-DD HH:mm");r.time_isostring=a.toISOString(),r.time=a;var n=/^(.*?)\s/.exec(r.meta);if(n&&(r.logo="/images/"+n[1].toLowerCase()+".png"),n=/Länge: (.*?)\)/.exec(r.meta)){var s=n[1],c=s.split(":");c&&(r.duration=60*parseInt(c[0])+parseInt(c[1])),n=/\s(\d\d:\d\d),/.exec(r.meta),n&&(c=r.meta.split(", "),c&&(r.start=Moment(c[1]+c[2],"D. MMM YYYY HH:mm"),r.end=Moment(r.start).add(r.duration,"seconds")))}t.td[1]&&t.td[1].div&&t.td[1].div.a&&t.td[1].div.a.forEach(function(e){/^mp3/i.test(e.content)&&(/\.m3u$/.test(e.href)?r.playlist=e.href:r.stream=e.href)});break;case"Autor(en):":r.autor=t.td[i+1].content;break;case"Inhaltsangabe:":r.inhalt=getText(t.td[i+1]);break;case"Produktion:":r.produktion=t.td[i+1];break;case"Komponist(en):":r.komponisten=t.td[i+1].content;break;case"Regisseur(e):":r.regisseure=t.td[i+1].content;break;case"Übersetzer:":r.uebersetzer=t.td[i+1].content;break;case"Mitwirkende:":r.mitwirkende=require("controls/staff")(t.td[i+1])}}),r.title&&i.push(r),i.sort(function(e,t){return e.time.unix()-t.time.unix()})}}),Ti.App.Properties.setString(e.date,JSON.stringify(i)),e.onload(i)}else console.log("wrong answer from YQL"),console.log(i)})};var _={td:[{"class":"right",content:"Sendetermine:"},{br:null,div:{"class":"streams",a:[{href:"http://www.dradio.de/streaming/dkultur.asx",title:"DLR-Windows Mediaplayer-Stream",content:"winmedia-Stream"},{href:"http://www.dradio.de/streaming/dkultur.m3u",title:"DLR-MP3-Stream",content:"mp3-Stream"},{href:"http://www.dradio.de/streaming/dkultur_mq_ogg.m3u",title:"DLR-Ogg Vorbis-Stream (mittlere Qualität)",content:"ogg-Stream"},{href:"http://www.dradio.de/streaming/dkultur_hq_ogg.m3u",title:"DLR-Ogg Vorbis-Stream (hohe Qualität)",content:"ogg-Stream"}],content:" [] \n [] \n [] \n [] \n"},content:" DLR - Montag,  6. Apr 2015 00:05, (angekündigte Länge:    55:00)\n\n"}]};