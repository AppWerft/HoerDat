function getText(t){return t?"string"==typeof t?t.replace(/\n/gm,"").trim():t.content?t.content.replace(/[\s]{3,}/gm,"\n").trim():t[0].content.replace(/[\s]{3,}/gm,"\n").trim():""}var Moment=require("vendor/moment");Moment.locale("de"),module.exports=function(t){if(Ti.App.Properties.hasProperty(t.date))return void t.onload(JSON.parse(Ti.App.Properties.getString(t.date)));var e='select * from html where url="http://s507870211.online.de/index.php?aktion=suche&dat='+t.date+'" and xpath="//table"';return void Ti.Yahoo.yql(e,function(e){if(e.success&&e.data&&e.data.table&&Array.isArray(e.data.table)){var r=e.data.table,a=[];r.forEach(function(e){if("form"!=e["class"]){var r={};e.tbody.tr&&e.tbody.tr instanceof Array&&e.tbody.tr.forEach(function(e){if(e.th&&(r.title=e.th.h1,r.subtitle=e.th.h2),e.td&&"navi"!=e.td["class"])for(var a=0;a<e.td.length;a++)if("right"==e.td[a]["class"])switch(e.td[a].content){case"Sendetermine:":r.meta=getText(e.td[a+1].content).replace("angekündigte Länge:    ","ca. Länge:"),r.station=r.meta.split(" - ")[0];var i=r.meta.match(/\s(\d\d:\d\d)/);r.time=i[1];var n=t.date+" "+r.time,o=Moment(n,"YYYY-MM-DD HH:mm");r.time_isostring=o.toISOString(),r.time=o;var i=/^(.*?)\s/.exec(r.meta);if(i&&(r.logo="/images/"+i[1].toLowerCase()+".png"),i=/Länge: (.*?)\)/.exec(r.meta)){var s=i[1],d=s.split(":");d&&(r.duration=60*parseInt(d[0])+parseInt(d[1])),i=/\s(\d\d:\d\d),/.exec(r.meta),i&&(d=r.meta.split(", "),d&&(r.start=Moment(d[1]+d[2],"D. MMM YYYY HH:mm"),r.end=Moment(r.start).add(r.duration,"seconds")))}e.td[1]&&e.td[1].div&&e.td[1].div.a&&e.td[1].div.a.forEach(function(t){/^mp3/i.test(t.content)&&(/\.m3u$/.test(t.href)?r.playlist=t.href:r.stream=t.href)});break;case"Autor(en):":r.autor=e.td[a+1].content;break;case"Inhaltsangabe:":r.inhalt=getText(e.td[a+1]);break;case"Produktion:":r.produktion=e.td[a+1];break;case"Komponist(en):":r.komponisten=e.td[a+1].content;break;case"Regisseur(e):":r.regisseure=e.td[a+1].content;break;case"Übersetzer:":r.uebersetzer=e.td[a+1].content;break;case"Mitwirkende:":r.mitwirkende=require("controls/staff")(e.td[a+1])}}),r.title&&a.push(r),a.sort(function(t,e){return t.time.unix()-e.time.unix()})}}),Ti.App.Properties.setString(t.date,JSON.stringify(a)),t.onload(a)}else console.log("wrong answer from YQL"),console.log(a)})};var _={td:[{"class":"right",content:"Sendetermine:"},{br:null,div:{"class":"streams",a:[{href:"http://www.dradio.de/streaming/dkultur.asx",title:"DLR-Windows Mediaplayer-Stream",content:"winmedia-Stream"},{href:"http://www.dradio.de/streaming/dkultur.m3u",title:"DLR-MP3-Stream",content:"mp3-Stream"},{href:"http://www.dradio.de/streaming/dkultur_mq_ogg.m3u",title:"DLR-Ogg Vorbis-Stream (mittlere Qualität)",content:"ogg-Stream"},{href:"http://www.dradio.de/streaming/dkultur_hq_ogg.m3u",title:"DLR-Ogg Vorbis-Stream (hohe Qualität)",content:"ogg-Stream"}],content:" [] \n [] \n [] \n [] \n"},content:" DLR - Montag,  6. Apr 2015 00:05, (angekündigte Länge:    55:00)\n\n"}]};